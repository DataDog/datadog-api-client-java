/*
 * Unless explicitly stated otherwise all files in this repository are licensed under the Apache-2.0 License.
 * This product includes software developed at Datadog (https://www.datadoghq.com/).
 * Copyright 2019-Present Datadog, Inc.
 *
 * NOTE: This class is auto generated by OpenAPI Generator (https://openapi-generator.tech).
 * https://openapi-generator.tech
 * Do not edit the class manually.
 */

package com.datadog.api.v1.client.api;

import com.datadog.api.TestUtils;
import com.datadog.api.v1.client.ApiException;
import com.datadog.api.v1.client.model.APIErrorResponse;
import com.datadog.api.v1.client.model.PagerDuty;
import com.datadog.api.v1.client.model.PagerDutyService;
import com.datadog.api.v1.client.model.PagerDutyServicesAndSchedules;

import org.junit.AfterClass;
import org.junit.BeforeClass;
import org.junit.Test;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import java.time.OffsetDateTime;

import static org.junit.Assert.assertEquals;
import static org.junit.Assert.assertNotNull;

/**
 * API tests for PagerDutyIntegrationApi
 */
public class PagerDutyIntegrationApiTest extends V1ApiTest {

    private static PagerDutyIntegrationApi api;

    @BeforeClass
    public static void initAPI() {
        api = new PagerDutyIntegrationApi(generalApiClient);
    }

    @AfterClass
    public static void removeIntegration() {
        try {
            api.deletePagerDutyIntegration().execute();
        } catch(ApiException e) {
            System.out.println(String.format("Problem with removing PagerDuty integration: %s", e));
        }
    }

    /**
     * Make sure that there is not parallel execution.
     *
     * @throws TestUtils.RetryException
     */
    protected void ensureNoPagerDuty() throws TestUtils.RetryException {
        TestUtils.retry(5, 10, () -> {
            try {
                api.getPagerDutyIntegration().execute();
            } catch (ApiException e) {
                // integration does not exist
                return true;
            }
            // wait until other test finish
            return false;
        });
    }

    /**
     * Test a PagerDuty integration lifecycle
     *
     * @throws ApiException
     *          if the Api call fails
     */
    @Test
    public void lifecyclePagerDutyIntegrationTest() throws ApiException, TestUtils.RetryException {
        ensureNoPagerDuty();

        PagerDuty body = new PagerDuty()
            .subdomain("_deadbeef")
            .apiToken("y_NbAkKc66ryYTWUXYEu");

        api.createPagerDutyIntegration()
            .body(body)
            .execute();

        PagerDuty pagerDuty = api.getPagerDutyIntegration().execute();
        assertEquals(body.getSubdomain(), pagerDuty.getSubdomain());

        PagerDutyServicesAndSchedules servicesAndSchedules = new PagerDutyServicesAndSchedules()
            .addServicesItem(new PagerDutyService()
                .serviceName("test_java")
                .serviceKey("deadbeef"))
            .addSchedulesItem(
                "https://_deadbeef.pagerduty.com/schedules#DEAD3F"
            );

        api.updatePagerDutyIntegration()
                .body(servicesAndSchedules)
                .execute();

        PagerDuty updatedPagerDuty = api.getPagerDutyIntegration().execute();

        assertEquals(pagerDuty.getSubdomain(), updatedPagerDuty.getSubdomain());
        for (int index = 0; index < updatedPagerDuty.getServices().size(); index++) {
            PagerDutyService service = updatedPagerDuty.getServices().get(index);
            assertEquals(service.getServiceName(), servicesAndSchedules.getServices().get(index).getServiceName());
        }
    }

    /**
     * Delete a PagerDuty integration
     *
     * @throws ApiException if the Api call fails
     */
    @Test
    public void deletePagerDutyIntegrationTest() throws ApiException, TestUtils.RetryException {
        ensureNoPagerDuty();

        String response = api.deletePagerDutyIntegration().execute();
    }

    /**
     * Get a PagerDuty integration
     *
     * @throws ApiException if the Api call fails
     */
    @Test
    public void getPagerDutyIntegrationTest() throws ApiException, TestUtils.RetryException {
        ensureNoPagerDuty();

        try {
            api.getPagerDutyIntegration().execute();
        } catch (ApiException e) {
            assertEquals(404, e.getCode());
        }
    }
}
